function Cube8(a){this.Data=a;this.Dims=[];this.RollupKey="Rollup";this.RollupFx=function(a,c){return a&&c?a+c:a?a:c};this.FactComps={}}Cube8.FX={DefCompFx:function(a,b){return a===b},DefGroupRowFX:function(a,b){return b},DefGroupColFX:function(a,b){return b},DefFilterNest:function(a,b,c){return!0},DefModNest:function(a){}};Cube8.IDX=function(a,b,c){var g;return a.every(function(a,d){g=d;return!c(a,b)})?(a.push(b),a.length-1):g};
Cube8.OneLoop=function(a,b){var c=a.length,g=c,k=[],d=[],e=0,h,f,l=1,m;a.forEach(function(b,e){k.push(l);l*=a[c-(e+1)];d.push(b);g*=b});for(k.reverse();e<g;)h=Math.floor(e/c),f=e%c,0==f?l=h:0,d[f]=Math.floor(l/k[f]),l%=k[f],f==c-1?(m=b(d,h,k),e+=m?(m-1)*c:0):0,e++};Cube8.prototype.Dim=function(a,b,c){c?1:c=Cube8.FX.DefCompFx;var g={Name:b},g=Cube8.IDX(this.Dims,g,function(a,b){return a.Name==b.Name}),g=this.Dims[g];g.fx=a;g.CompFx=this.FactComps[b]=c;return this};
Cube8.prototype.SetRollupFx=function(a,b){this.RollupKey=b?b:this.RollupKey;this.RollupFx=a;return this};Cube8.prototype.SetMeasureFx=function(a){this.AggFx=a;return this};Cube8.prototype.GetDimFacts=function(a){var b=this,c={},g,k,d=this.Dims,e,h;Cube8.OneLoop([this.Data.length,d.length],function(f){h=b.Data[f[0]];e=d[f[1]];if(!a||0<=a.indexOf(e.Name))g=c[e.Name]||(c[e.Name]=[]),k=e.fx(h),Cube8.IDX(g,k,e.CompFx)});return c};
Cube8.prototype.GetMeasure=function(a){a?1:a={};var b,c=this,g,k=!0,d={},e=this.Dims.length,h,f,l,m,v=this.Dims,n;Cube8.OneLoop([this.Data.length,e],function(t){f=c.Data[t[0]];h=t[1];n=v[h];d[n.Name]=l=n.fx(f);0==h?k=!0:0;m=a.hasOwnProperty(n.Name)?a[n.Name]:void 0;k&=a.call||void 0==m?1:m.call?m(l,n.Name,f):n.CompFx(m,l);h==e-1&&(b=c.AggFx(f,d),(k&=a.call?a(d,b):1)?g=c.RollupFx(g,b,f):1);return k?0:e-h});return g};
Cube8.prototype.NestDim=function(a,b,c,g){var k=this;c=c?c:Cube8.FX.DefFilterNest;g=g?g:Cube8.FX.DefModNest;var d={};this.Dims.forEach(function(b){0<=a.indexOf(b.Name)&&(d[b.Name]=b)});var e=[],h=e,f,l={},m,v=this.Dims,n=a.length-1,t,p,q,r,u;Cube8.OneLoop([this.Data.length,a.length],function(w){t=w[0];p=w[1];r=k.Data[t];m=d[a[p]];0==p&&(v.forEach(function(a,b){l[a.Name]=a.fx(r)}),q=k.AggFx(r),u=c(l,q,r));if(u)f={Fact:l[m.Name],DimName:m.Name,NextDim:p<n?[]:null,Level:p},f=h[Cube8.IDX(h,f,function(a,
b){return m.CompFx(a.Fact,b.Fact)})],b?f[k.RollupKey]=k.RollupFx(q,f[k.RollupKey]):1,g(f),h=p<n?f.NextDim:e;else return a.length});return e};Cube8.DefaultFX={GroupRowFX:function(a,b){return b},GroupColFX:function(a,b){return b}};
Cube8.prototype.Drill=function(a,b,c,g){function k(a,b){Y=!0;for(var c in b)if(Y&=e.FactComps[c]?e.FactComps[c](a[c],b[c]):a[c]===a[nb],!Y)break;return Y}c?1:c=Cube8.DefaultFX.GroupRowFX;g?1:g=Cube8.DefaultFX.GroupColFX;var d={ColumnFacts:[],RowFacts:[],Measures:{},Right:[],Bottom:[],One:null,Get:function(a,b){return this.Measures(a+"."+b)}},e=this,h=this.Dims,f=h.length,l,m,v,n,t,p,q,r,u,w,x={},y;Cube8.OneLoop([this.Data.length,f],function(z){n=z[0];v=z[1];m=e.Data[n];l=h[v];t=l.fx(m);x[l.Name]=
t;0==v?(u={},w={}):1;a&&0!=a.length?0<=a.indexOf(l.Name)&&(w[l.Name]=g(l.Name,t)):w={Column:"Column"};b&&0!=b.length?0<=b.indexOf(l.Name)?u[l.Name]=c(l.Name,t):1:u={Row:"Row"};v==f-1&&(q=Cube8.IDX(d.ColumnFacts,w,k),d.Bottom.length<d.ColumnFacts.length?d.Bottom.push(null):1,r=Cube8.IDX(d.RowFacts,u,k),d.Right.length<d.RowFacts.length?d.Right.push(null):1,y=e.AggFx(m,x),p=r+"."+q,d.Measures[p]=e.RollupFx(d.Measures[p],y),d.Right[r]=e.RollupFx(d.Right[r],y),d.Bottom[q]=e.RollupFx(d.Bottom[q],y),d.One=
e.RollupFx(d.One,y))});return d};Cube8.prototype.Table=function(a,b,c,g){return this.Drill([a],[b],c,g)};
Cube8.prototype.Consolidate=function(a,b){b?1:b=function(){return!0};var c=this,g=[],k=[],d={},e=[],h=(new Cube8(e)).SetMeasureFx(function(b){return b[a.length]}).SetRollupFx(this.RollupFx,this.RollupKey),f=this.Dims,l=f.length,m={},v,n,t,p,q,r,u,w,x;f.forEach(function(b,e){var f=a.indexOf(b.Name);0<=f&&(h.Dim(function(a){return a[f]},b.Name,c.FactComps[b.Name]),d[b.Name]=f,k.push(0),g.push([]))});Cube8.OneLoop([this.Data.length,l],function(h){v=h[0];n=h[1];t=c.Data[v];x=f[n];q=x.Name;0==n?(p={},
r=Array(a.length+1)):1;p[x.Name]=x.fx(t);null!=d[q]&&(r[d[q]]=p[q],h=Cube8.IDX(g[d[q]],p[q],c.FactComps[q]),k[d[q]]=h);n==l-1&&(w=c.AggFx(t,p),b(p,w)&&(u=k.join("."),null==m[u]?(m[u]=e.length,e.push(r)):r=e[m[u]],r[a.length]=c.RollupFx(r[a.length],w)))});return h};
